<% @page_title = "Student Status Report" %>

<p>
<%= link_to "Back to Course: #{@course.name}", @course %>

<% if @logged_in_user.course_admin?(@course) %>
  | <%= link_to "Manage Registrations", course_registrations_path(@course) %>
<% end %>
</p>

<table class="pretty-list">
  <tr>
    <td>Course</td>
    <td><%= @course.name %></td>
  </tr>
  <tr>
    <td>User</td>
    <td><%= @user.name %></td>
  </tr>
  <tr>
    <td>Teacher?</td>
    <td>
      <%= @registration.teacher? ? "Yes" : "No" %>
      <% if @logged_in_user.course_admin?(@course) %>
        (<%= link_to "Edit", [:edit, @registration] %>)
      <% end %>
    </td>
  </tr>
</table>

<h1>Assignments</h1>

<table class="pretty-list">
  <tr>
    <th>Chapter</th>
    <th>Name</th>
    <th>Status</th>
    <th>Attempts</th>
    <th>Score</th>
    <th>Graded&nbsp;By</th>
    <th>Submission</th>
  </tr>

<% score_sum = 0; score_total = 0 %>

<% @course.chapters.order(:name).each do |chapter| %>
  <% chapter.assignments.order(:name).each do |assignment| %>
    <% sub = assignment.best_submission_for(@user) %>
    <% unless assignment.hide_grading? 
         score_sum += assignment.best_score_for(@user) 
       end %>
    <% score_total += assignment.points_available %>
    <tr>
      <td><%= chapter.name %></td>
      <td><%= assignment.name %></td>
      <td><%= status_image(sub) %></td>
      <td><%= assignment.submissions_for(@user).count %>
	(<%= link_to "List", user_assignment_submissions_path(@user, assignment) %>)
      </td>
      <td><%= show_score(assignment.best_score_for(@user), assignment)
	%>&nbsp;/&nbsp;<%= assignment.points_available %></td>
      <td>
	<% if sub.teacher_score.nil? %>
	  Computer
	<% else %>
	  Human
	<% end %>
      </td>
      <td><%= (sub.nil? || sub.new_record?) ? '-' : link_to("Best", sub) %></td>
    </tr>
  <% end %>
<% end %>

<tr>
  <td><strong>Total</strong></td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td><%= score_sum %>&nbsp;/&nbsp;<%= score_total %></td>
  <td>( <%=  100.0 * score_sum / score_total %>% )</td>
  <td>&nbsp;</td>
</tr>

</table>

<h1>Questions</h1>

<table class="pretty-list">
  <tr>
    <th>Chapter</th>
    <th>Lesson</th>
    <th>Question #</th>
    <th>Attempts</th>
    <th>Status</th>
  </tr>

<% @course.chapters.each do |chapter| %>
  <% chapter.lessons.each do |lesson| %>
    <% lesson.questions.each_index do |ii| %>
      <% question = lesson.questions[ii] %>
        <tr>
	  <td><%= chapter.name %></td>
	  <td><%= lesson.name %></td>
	  <td><%= "#{ii + 1} / #{lesson.questions.size} " %></td>
	  <td><%= question.answers_for(@user).size %></td>
	  <td><%= image_tag question.best_score_image_for(@user), :height => 32 %></td>
	</tr>
    <% end %>
  <% end %>
<% end %>

</table>


